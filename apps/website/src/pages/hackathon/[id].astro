---
import Layout from '../../layouts/default.astro';
import PageHeader from '../../components/page-header.astro';
import YoutubeVideoPlayer from '../../components/youtube-video-player.astro';
import MuxVideoPlayer from '../../components/mux-video-player.astro';
import Grid from '../../components/design-system/grid.astro';
import Card from '../../components/design-system/card.astro';
import List from '../../components/design-system/list.astro';
import Block from '../../components/design-system/block.astro';
import { getAllHackathons, getHackathonBySlug } from '@codetv/sanity';
import type { HackathonBySlugQueryResult } from '@codetv/types';
import { marked } from 'marked';

export const prerender = true;

export async function getStaticPaths() {
	const hackathons = await getAllHackathons();

	return hackathons.map((hackathon) => ({
		params: { id: hackathon.slug },
		props: { slug: hackathon.slug },
	}));
}

const { slug } = Astro.props;
const hackathon = await getHackathonBySlug({ slug: slug! });

if (!hackathon) {
	return Astro.redirect('/404');
}

// Calculate status based on deadline
const now = new Date();
const deadline = hackathon.deadline ? new Date(hackathon.deadline) : null;
const isActive = deadline ? now < deadline : false;
const statusText = isActive ? 'Active' : 'Closed';
const statusClass = isActive ? 'active' : 'closed';

// Format deadline for display
const deadlineFormatted = deadline
	? deadline.toLocaleDateString('en-US', {
			month: 'short',
			day: 'numeric',
		})
	: 'TBD';

// Get first sponsor if available
const primarySponsor = hackathon.sponsors?.[0];

// Hero image - use share_image or default
const heroImage = hackathon.share_image
	? {
			public_id: hackathon.share_image.public_id!,
			alt: hackathon.title || 'Hackathon',
		}
	: {
			public_id: 'codetv-home-hero',
			alt: 'CodeTV Web Dev Challenge',
		};

// SEO meta
const pageTitle = `${hackathon.title} â€” CodeTV`;
const pageDescription =
	hackathon.description || 'Join the CodeTV Web Dev Challenge hackathon';
const pageImage = hackathon.share_image?.public_id
	? `https://res.cloudinary.com/jlengstorf/image/upload/w_1600,h_900,c_fill,f_auto,q_auto/${hackathon.share_image.public_id}`
	: 'https://res.cloudinary.com/jlengstorf/image/upload/f_auto/q_auto/v1738215362/codetv/codetv-default-cover.png';

// Parse markdown body
const bodyHtml = hackathon.body ? await marked.parse(hackathon.body) : '';

// Debug: Log what data we have
console.log('Hackathon data check:', {
	hasRewards: hackathon.rewardsData?.length,
	hasRules: hackathon.rules?.length,
	hasResources: hackathon.resources?.length,
	hasFaq: hackathon.faqData?.length,
	hasSponsors: hackathon.sponsors?.length,
});
---

<Layout title={pageTitle} description={pageDescription} image={pageImage}>
	<main>
		<PageHeader
			image={heroImage}
			line1={hackathon.title || 'Web Dev Challenge'}
			line2="Join the Challenge"
		/>

		<Block name="overview" variant="two-column-asymmetrical">
			<Card>
				<aside class="hackathon-details">
					<dl>
						<dt>Status</dt>
						<dd>
							<span class={`status ${statusClass}`}></span>
							{statusText}
						</dd>

						<dt>Deadline</dt>
						<dd>
							<time datetime={hackathon.deadline || ''}
								>{deadlineFormatted}</time
							>
						</dd>

						{
							primarySponsor && (
								<>
									<dt>Sponsor</dt>
									<dd>
										{primarySponsor.logo?.public_id ? (
											<img
												src={`https://res.cloudinary.com/jlengstorf/image/upload/w_200,f_auto,q_auto/${primarySponsor.logo.public_id}`}
												alt={primarySponsor.title || 'Sponsor'}
												class="sponsor-image"
											/>
										) : (
											<span>{primarySponsor.title}</span>
										)}
									</dd>
								</>
							)
						}
					</dl>

					{
						hackathon.submissionForm && (
							<a href={hackathon.submissionForm} class="button">
								Submit Your App
							</a>
						)
					}
				</aside>
			</Card>

			<div class="text-block challenge">
				<div class="copy">
					{hackathon.description && <p class="lede">{hackathon.description}</p>}
					{bodyHtml && <div class="body-content" set:html={bodyHtml} />}
				</div>
			</div>
		</Block>

		{
			hackathon.episode && (
				<Block name="episode">
					<h2>Watch the full episode for inspiration</h2>
					<figure>
						{hackathon.episode.video?.youtube_id ? (
							<YoutubeVideoPlayer
								youtube_id={hackathon.episode.video.youtube_id}
								title={hackathon.episode.title || 'Watch the episode'}
							/>
						) : hackathon.episode.video?.mux ? (
							<MuxVideoPlayer
								playback_ids={hackathon.episode.video.mux.map((v) => ({
									id: v.id ?? '',
									policy: v.policy as 'public' | 'signed',
								}))}
								title={hackathon.episode.title || 'Watch the episode'}
								publish_date={null}
							/>
						) : null}
						<figcaption>
							<span>
								Watch the challenge in action to jumpstart your creativity
							</span>
							<a href={`/series/web-dev-challenge/${hackathon.episode.slug}`}>
								Watch the episode &rarr;
							</a>
						</figcaption>
					</figure>
				</Block>
			)
		}

		{
			hackathon.rewardsData && hackathon.rewardsData.length > 0 && (
				<Block name="rewards">
					<h2>Submit an app to earn rewards</h2>

					<Grid columns={3}>
						{hackathon.rewardsData.map((reward) => (
							<Card title={reward.title || ''}>
								{reward.image?.public_id && (
									<img
										slot="img"
										src={`https://res.cloudinary.com/jlengstorf/image/upload/w_400,f_auto,q_auto/${reward.image.public_id}`}
										alt={reward.title || 'Reward'}
									/>
								)}
								<p>{reward.description}</p>
							</Card>
						))}
					</Grid>
				</Block>
			)
		}

		{
			primarySponsor && (
				<Block name="sponsor" emphasized>
					<div class="inline">
						<p>
							This challenge is brought to you by{' '}
							<strong>{primarySponsor.title}</strong>
						</p>

						{primarySponsor.link && (
							<a href={primarySponsor.link} class="button secondary">
								learn more &rarr;
							</a>
						)}
					</div>
				</Block>
			)
		}

		{
			hackathon.resources && hackathon.resources.length > 0 && (
				<Block name="resources" variant="two-column-asymmetrical">
					<div class="heading">
						<h2>Resources</h2>
					</div>

					<List>
						{hackathon.resources.map((resource) => (
							<Card variant="secondary">
								<p slot="title">
									<a href={resource.url || '#'}>{resource.title} &rarr;</a>
								</p>
								<p>{resource.description}</p>
							</Card>
						))}
					</List>
				</Block>
			)
		}

		{
			hackathon.rules && hackathon.rules.length > 0 && (
				<Block name="rules" variant="two-column-asymmetrical">
					<div class="heading">
						<h2>The Rules</h2>
					</div>

					<List>
						{hackathon.rules.map((rule, index) => (
							<Card title={`#${index + 1}: ${rule.title}`}>
								<p>{rule.description}</p>
							</Card>
						))}
					</List>
				</Block>
			)
		}

		{
			hackathon.submissionForm && (
				<Block name="submit" emphasized>
					<h2>Show us what you built!</h2>
					<a href={hackathon.submissionForm} class="button">
						Submit Your App
					</a>
				</Block>
			)
		}

		{
			hackathon.faqData && hackathon.faqData.length > 0 && (
				<Block name="faq" variant="two-column-asymmetrical">
					<div class="heading">
						<h2>FAQ</h2>
					</div>

					<List>
						{hackathon.faqData.map((faq) => (
							<Card variant="secondary" title={faq.question || ''}>
								<p>{faq.answer}</p>
							</Card>
						))}
					</List>
				</Block>
			)
		}
	</main>
</Layout>

<style>
	.hackathon-details {
		display: flex;
		flex-direction: column;
		gap: 40px;
		justify-content: space-between;

		dl {
			align-items: center;
			display: grid;
			font-size: 0.75em;
			grid-template-columns: repeat(2, minmax(0, 1fr));
			grid-template-rows: repeat(3, minmax(0, 40px));
			letter-spacing: 0.25em;
			text-transform: uppercase;
		}

		dt {
			color: var(--text-muted);
		}

		dd {
			align-items: center;
			color: var(--text-emphasized);
			display: flex;
			gap: 8px;
			justify-content: end;

			.status {
				block-size: 12px;
				border-radius: 50%;
				display: block;
				inline-size: 12px;

				&.active {
					background: #79f664;
				}

				&.closed {
					background: #ff6b6b;
				}
			}
		}

		.sponsor-image {
			max-height: 40px;
			width: auto;
		}

		.button {
			inline-size: 100%;
			text-align: center;
		}
	}

	h2 {
		font-family: var(--font-family-heading);
		font-size: clamp(1.75rem, 3.75cqi, 4.25rem);
		font-weight: normal;
		line-height: 1;
		margin: 0;
	}

	.copy {
		display: flex;
		flex-direction: column;
		gap: 16px;

		.lede {
			color: var(--text-emphasized);
			font-size: 1.25em;
			font-weight: 300;
			line-height: 1.25;
		}

		.body-content {
			display: flex;
			flex-direction: column;
			gap: 16px;

			h2 {
				font-size: clamp(1.5rem, 3cqi, 2.5rem);
				margin-block-start: 32px;
			}

			h3 {
				font-size: clamp(1.25rem, 2.5cqi, 2rem);
				margin-block-start: 24px;
			}

			p {
				line-height: 1.6;
			}

			ul,
			ol {
				padding-inline-start: 24px;
				display: flex;
				flex-direction: column;
				gap: 8px;
			}

			li {
				line-height: 1.6;
			}

			a {
				color: var(--text-link);
				text-decoration: underline;
				text-decoration-color: var(--text-muted);
				text-underline-offset: 4px;
				transition: text-decoration-color 0.2s;

				&:hover {
					text-decoration-color: var(--text-link);
				}
			}

			code {
				background: var(--background-offset);
				padding: 2px 6px;
				border-radius: 4px;
				font-size: 0.9em;
			}

			strong {
				font-weight: 600;
			}
		}
	}

	figure {
		inline-size: min(90cqi, 980px);

		lite-youtube {
			block-size: auto;
			max-inline-size: 100%;
		}

		figcaption {
			color: var(--text-muted);
			display: flex;
			font-size: 0.875em;
			justify-content: space-between;
			padding-block: 8px;

			a {
				color: var(--text-emphasized);
				font-weight: 500;
				text-decoration: none;
			}
		}
	}

	.inline {
		align-items: center;
		display: flex;
		flex-direction: column;
		gap: 24px;

		p {
			align-items: center;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		svg {
			block-size: 32px;
			inline-size: auto;
			margin-block-start: 4px;
		}

		.button {
			margin: 0;
		}

		@media (min-width: 1024px) {
			flex-direction: row;

			p {
				flex-direction: row;
			}
		}
	}

	.list-fine-print {
		color: var(--text-muted);
		font-size: 0.75em;
		padding-inline: 16px;
	}

	[data-name='submit'] {
		text-align: center;

		.button {
			margin-block-start: 24px;
		}
	}
</style>

<style is:global>
	@layer overrides {
		.hero .line-2 {
			font-size: 0.5em;
			letter-spacing: -0.01em;
		}

		[data-name='overview'] {
			justify-items: center;

			.card {
				min-inline-size: 280px;
			}
		}

		[data-name='rewards'] {
			--grid-width: 980px;

			align-items: center;
			display: flex;
			flex-direction: column;
			gap: 16px;
		}
	}
</style>
