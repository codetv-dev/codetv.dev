---
import { format } from 'date-fns';
import { marked } from 'marked';
import { Image } from '@unpic/astro';
import {
	getAllEpisodes,
	getEpisodeTranscriptBySlug,
	getSeriesBySlug,
} from '@codetv/sanity';
import {
	createImageUrl,
	generateDefaultImage,
	getYouTubeThumbnail,
} from '@codetv/cloudinary';
import Layout from '../../../../layouts/default.astro';
import PeopleInEpisode from '../../../../components/people-in-episode.astro';
import Supporters from '../../../../components/supporters.astro';
import Card from '../../../../components/cards/card.astro';
import HackathonStatusCard from '../../../../components/hackathon-status-card.astro';
import PageHeader from '../../../../components/page-header.astro';
import { getRelativeAge } from '../../../../util/helpers';

export const prerender = true;

export async function getStaticPaths() {
	const allEpisodes = await getAllEpisodes();

	const paths = await Promise.all(
		allEpisodes.map(async (e) => {
			if (!e.series || !e.collection || !e.slug) {
				console.log(e);
				return false;
			}

			const episode = e;

			return {
				params: {
					seriesSlug: e.series.slug,
					collectionSlug: e.collection.slug,
					episodeSlug: e.slug,
				},
				props: { episode },
			};
		}),
	);

	return paths.filter(Boolean);
}

const { episode } = Astro.props;

const description = marked.parse(episode.description ?? '');

const episodeIndex =
	episode.related_episodes?.findIndex((e) => e.slug === episode.slug) ?? 0;

const episodeNumber = (
	episode.collection?.slug + `.E${episodeIndex + 1}`
).toUpperCase();

const relatedEpisodes = episode.related_episodes ?? [];

const url = Astro.site!;
url.pathname = `/series/${episode.series?.slug}/${episode.collection?.slug}/${episode.slug}`;

const thumb_w = 1600;
const thumb_h = 900;

let image;
if (episode.thumbnail.public_id) {
	image = createImageUrl(episode.thumbnail.public_id, {
		width: thumb_w,
		aspect_ratio: `${thumb_w}:${thumb_h}`,
		crop: 'fill',
	});
} else if (episode.video?.youtube_id) {
	image = getYouTubeThumbnail(episode.video.youtube_id);
} else {
	image = generateDefaultImage({ text: episode.title ?? '' });
}

const transcriptRaw = await getEpisodeTranscriptBySlug({
	episode: episode.slug!,
});
const transcript = marked.parse(transcriptRaw ?? '');

const title =
	episode.title +
	' | ' +
	episode.series?.title +
	' ' +
	episode.collection?.title;

const { seriesSlug, collectionSlug } = Astro.params;

if (!seriesSlug || !collectionSlug) {
	throw new Error('Invalid series and/or collection provided.');
}

const series = await getSeriesBySlug({
	series: seriesSlug,
	collection: collectionSlug,
});

if (!series) {
	throw new Error(`Invalid series for ${seriesSlug}`);
}

if (!series.image || !series.image.public_id) {
	throw new Error('Missing series image');
}
---

<Layout title={title}>
	<Fragment slot="head">
		<link rel="canonical" href={url.toString()} />
		<meta name="description" content={episode.short_description} />
		<meta name="image" content={image} />

		<meta property="og:type" content="video.episode" />
		<meta property="og:title" content={title} />
		<meta property="og:site_name" content="CodeTV" />
		<meta property="og:description" content={episode.short_description} />
		<meta property="og:url" content={Astro.url} />

		<meta property="og:image" content={image} />
		<meta property="og:image:width" content={thumb_w.toString()} />
		<meta property="og:image:height" content={thumb_h.toString()} />
		<meta property="og:image:alt" content={episode.thumbnail?.alt ?? title} />

		<meta name="twitter:dnt" content="on" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:description" content={episode.short_description} />
		<meta name="twitter:image" content={image} />
		<meta name="twitter:creator" content="@codetv_dev" />

		<script
			type="application/ld+json"
			set:html={`
			{
				"@context": "https://schema.org",
				"@type": "TVEpisode",
				"url": "${Astro.url}",
				"name": "${title}",
				"image": "${image}",
				"description": "${episode.short_description}",
				"datePublished": "${format(new Date(episode.publish_date!), 'yyyy-MM-dd')}",
				"actor": [
					${episode.people?.map((person) => {
						return JSON.stringify(
							{
								'@type': 'Person',
								url: `https://codetv.dev/profile/${person.slug}`,
								name: person.name,
							},
							null,
							2,
						);
					})}
				],
				"creator": [
					{
						"@type": "Organization",
						"url": "https://codetv.dev"
					},
					{
						"@type": "Person",
						"url": "https://codetv.dev/profile/jlengstorf",
						"name": "Jason Lengstorf"
					}
				]
			}
		`}
		/>
	</Fragment>

	<main>
		<PageHeader
			image={{
				// @ts-expect-error
				public_id: episode?.banner?.public_id ?? series?.banner?.public_id,
				alt: episode?.banner?.alt ?? series.title,
			}}
			addGradient={true}
		>
			<Fragment slot="content">
				<div class="series-info">
					<Image
						src={createImageUrl(series.logo!)}
						alt={series.title}
						width={400}
					/>

					<div class="episode-meta">
						<a
							href={`/series/${episode.series?.slug}/${episode.collection?.slug}`}
							class="season-link">{episode.series?.title}</a
						>
						<span class="episode-number">
							{episodeNumber}
						</span>
						<span class="episode-date">
							{
								new Date(episode.publish_date!) > new Date()
									? `Coming ${format(new Date(episode.publish_date!), 'eeee, MMM d')}`
									: format(new Date(episode.publish_date!), 'MMM d, yyyy')
							}
						</span>
					</div>

					{
						episode
							? () => {
									const description = episode.short_description;
									const path = `/series/${series.slug}/${series.collection?.slug}/${episode.slug}/play`;
									const age = getRelativeAge(episode.publish_date);
									const date = new Date(
										episode.publish_date,
									).toLocaleDateString('en-US', {
										month: 'short',
										day: 'numeric',
									});

									let tag;
									if (age === 'FUTURE') {
										tag = `Coming ${date}`;
									}

									if (age === 'NEW') {
										tag = 'NEW';
									}

									return (
										<div class="latest-episode">
											<div class="title">
												{tag ? <p class="tag">{tag}</p> : null}
												<h3>
													<a href={path}>{episode.title}</a>
												</h3>
											</div>

											<p class="description">{description}</p>
											<div class="options">
												<a href={path} class="button" tabindex="-1">
													<svg
														xmlns="http://www.w3.org/2000/svg"
														fill="none"
														viewBox="0 0 15 18"
													>
														<path
															fill="#080217"
															d="M14.5 7.641a1 1 0 0 1 0 1.732l-13 7.506a1 1 0 0 1-1.5-.866V1A1 1 0 0 1 1.5.135l13 7.506Z"
															style="fill:#080217;fill:color(display-p3 .0314 .0078 .0902);fill-opacity:1"
														/>
													</svg>
													Watch
												</a>

												{episode.sponsors && episode.sponsors.length > 0 ? (
													<>
														<span>sponsored by</span>
														{episode.sponsors?.map((sponsor) => {
															return (
																<Image
																	src={createImageUrl(sponsor.logo.public_id!)}
																	width={sponsor.logo.width!}
																	height={sponsor.logo.height!}
																	alt={sponsor.title}
																/>
															);
														})}
													</>
												) : null}
											</div>
										</div>
									);
								}
							: null
					}
				</div>
			</Fragment>
		</PageHeader>

		<div class="wrapper">
			<section class="description">
				<div set:html={description} />

				{
					episode.resources && episode.resources.length > 0 ? (
						<div class="resources">
							<h2>Resources & Links</h2>

							<ul class="resources">
								{episode.resources.map((resource) => {
									if (!resource.url) {
										return null;
									}

									const label = resource.label ?? resource.url;

									return (
										<li class="resource">
											<a href={resource.url}>
												{label.replace(/^https:\/\/(www\.)?/, '')}
											</a>
										</li>
									);
								})}
							</ul>
						</div>
					) : null
				}

				{
					transcript ? (
						<div class="transcript">
							<details>
								<summary>Read the transcript</summary>

								<div set:html={transcript} />
							</details>
						</div>
					) : null
				}
			</section>

			<section class="additional-details">
				{
					episode.hackathons &&
						episode.hackathons.filter((h) => new Date(h.deadline!) > new Date())
							.length > 0 && (
							<div class="hackathon-section">
								{episode.hackathons
									.filter((h) => new Date(h.deadline!) > new Date())
									.map((hackathon) => {
										const url = new URL(Astro.url);
										url.pathname = `/hackathon/${hackathon.slug}`;

										return (
											<HackathonStatusCard
												deadline={hackathon.deadline}
												sponsors={hackathon.sponsors}
												submissionForm={url.toString()}
												buttonText="See Details & Join"
											>
												<div class="hackathon-header" slot="header">
													<p>Try the challenge yourself: join the hackathon!</p>
													<h3>{hackathon.title}</h3>
												</div>
											</HackathonStatusCard>
										);
									})}
							</div>
						)
				}

				<PeopleInEpisode people={episode.people ?? []} server:defer />

				<div class="supporters">
					<h2>Supporters</h2>
					<p>
						<a href="/support">
							Become a supporter to see yourself here on future episodes!
						</a>
					</p>
					<Supporters />
				</div>
			</section>

			{
				relatedEpisodes.length > 0 &&
				relatedEpisodes.length !== 1 &&
				relatedEpisodes.at(0)?.slug !== episode.slug ? (
					<section class="related-episodes">
						<h2>
							More episodes from {episode.series?.title}{' '}
							{episode.collection?.title}
						</h2>

						<div class="row three-up">
							{relatedEpisodes.map((related, index) => {
								const minIndex = Math.max(0, episodeIndex - 3);
								const maxIndex = Math.min(relatedEpisodes.length, minIndex + 6);
								if (
									related.slug === episode.slug ||
									index < minIndex ||
									index > maxIndex
								) {
									return null;
								}

								return (
									<Card
										image={{
											public_id: related.thumbnail?.public_id,
											alt: related.thumbnail?.alt ?? '',
										}}
										title={related.title}
										description={related.short_description}
										link={`/series/${episode.series?.slug}/${episode.collection?.slug}/${related.slug}`}
										linkText="Watch episode"
										youtube_id={related.video?.youtube_id}
									>
										<Fragment slot="tagline">
											<p class="series">{episode.series?.title}</p>
											<p class="episode-number">
												{`${episode.collection?.slug}.E${index + 1}`.toUpperCase()}
											</p>
										</Fragment>
									</Card>
								);
							})}
						</div>
					</section>
				) : null
			}
		</div>
	</main>
</Layout>

<style is:global>
	.hero {
		min-block-size: 360px;
	}
</style>

<style>
	.series-info {
		font-size: clamp(14px, 1.25cqi, 1.125rem);
		inset-block-end: 0;
		inset-inline-start: 5cqi;
		max-inline-size: 90%;
		position: absolute;
		z-index: 10;

		img {
			inline-size: min(400px, 40dvi) !important;
		}

		.episode-meta {
			display: flex;
			font-size: 1.125em;
			gap: 4px 16px;
			margin-block: 16px 8px;
		}

		.title {
			--font-size: clamp(14px, 4.5cqi, 1.125em);

			color: var(--text-emphasized);
			display: flex;
			flex-wrap: wrap;
			font-size: var(--font-size);
			font-weight: 400;
			gap: 8px 16px;
			line-height: 1.25;
			margin: 8px;
			margin-inline-start: 0;

			&:empty {
				display: none;
			}

			* {
				color: inherit;
				font-size: inherit;
				font-weight: inherit;
				line-height: inherit;
			}

			:is(h1, h2, h3, h4, h5, h6) {
				font-size: var(--font-size);
				font-variation-settings: 'wdth' 95;
				font-weight: 550;
				line-height: 1.1;
				margin: 0;

				summary & {
					display: inline-block;

					&::before {
						content: '\25B8';
						margin-inline-end: 4px;
					}

					:open &::before {
						content: '\25BE';
					}
				}
			}

			.tag {
				background: var(--gray-200);
				border-radius: 3px;
				color: var(--text);
				display: block;
				font-family: var(--font-family-heading);
				font-size: clamp(10px, 1cqi, 0.625em);
				font-weight: 700;
				letter-spacing: 0.15em;
				line-height: 1;
				padding: 4px;
				text-transform: uppercase;
				align-self: center;
				text-box-trim: trim-both;
				text-box-edge: cap alphabetic;
			}

			.episode-number {
				color: var(--text-muted);
			}

			a {
				color: inherit;
				text-decoration: none;

				&:is(:focusa, :active, :hover) {
					outline: none;
					text-decoration: underline;
				}
			}
		}

		.description {
			color: var(--text-muted);
			display: flex;
			flex-direction: column;
			font-optical-sizing: auto;
			font-size: clamp(14px, 1.375cqi, 1.125em);
			font-weight: 300;
			gap: var(--gap);
			line-height: 1.35;
			margin-block-end: 32px;
			max-inline-size: 45ch;
			padding-inline: 0;
			text-wrap: pretty;

			details & {
				margin-inline-start: 12px;
			}

			&:empty {
				display: none;
			}

			> * {
				color: inherit;
				font-size: inherit;
				line-height: inherit;
				margin: 0;
			}
		}

		.options {
			align-items: center;
			display: flex;
			gap: 16px;

			span {
				color: var(--text-muted);
				font-size: 0.625em;
				letter-spacing: 0.1em;
				text-transform: uppercase;
			}
		}

		.button {
			align-items: center;
			display: flex;
			font-size: 1em;
			font-weight: 600;
			gap: 8px;
			justify-self: start;
			margin-block: 0;
			margin-inline-end: 32px;
			padding-inline: 24px;

			svg {
				block-size: 16px;
			}
		}
	}
	.wrapper {
		background: var(--black);
		margin-inline: auto;
		max-inline-size: 1440px;
		padding: 40px 5cqw 80px;
		position: relative;

		@media (min-width: 750px) {
			display: grid;
			gap: 30px;
			grid-template-columns: calc(62% - 15px) minmax(0, 1fr);
			/* padding-block-start: 20px; */
		}
	}

	.video-player-placeholder {
		animation: 1s pulse infinite alternate linear;
		aspect-ratio: 16 / 9;
		background: var(--gray-100);
		block-size: 100%;
		inline-size: 100dvi;
		opacity: 0.25;
	}

	.thumbnail {
		inset: 0;
		position: absolute;

		img {
			block-size: 100%;
			display: block;
			inline-size: 100%;
			object-fit: contain !important;
		}
	}

	.header {
		@media (min-width: 750px) {
			display: flex;
			grid-column: 1 / 3;
			justify-content: space-between;
		}
	}

	.episode-details {
		h1 {
			font-size: clamp(1.5em, 2.5cqi, 2.5em);
			font-weight: 500;
			line-height: 1.1;
			margin-block: 4px 8px;
		}

		p {
			line-height: 1.25;
		}
	}

	.episode-links {
		align-items: center;
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		justify-content: center;
		margin-block-start: 1rem;

		@media (min-width: 1000px) {
			margin-block-start: 0;
		}

		label {
			color: var(--text-muted);

			input {
				display: block;
				font: inherit;
				inline-size: 300px;
			}
		}

		.button {
			background: var(--yellow-500);
			border: 1px solid var(--text-muted);
			block-size: min-content;
			color: var(--black);
			margin: 0;
			text-decoration: none;
		}

		.inline-heart {
			margin-inline-end: 0.5rem;
		}

		svg:not(.inline-heart) {
			display: block;
		}
	}

	.episode-meta {
		align-items: baseline;
		display: flex;
		flex-wrap: wrap;
		/* flex-direction: column; */
		font-size: 0.875rem;
		font-weight: 200;
		margin-block: 0.25rem;

		@media (min-width: 410px) {
			flex-direction: initial;
			gap: 0.5rem;
		}
	}

	.season-link {
		color: var(--text-emphasized);
		font-weight: 600;
		text-decoration: none;

		&:is(:focus, :hover, :active) {
			text-decoration: underline;
		}
	}

	.episode-number {
		font-weight: 600;
		text-transform: uppercase;
	}

	.episode-date {
		font-size: 0.875em;
	}

	.hackathon-section {
		margin-block-end: 2rem;
	}

	.hackathon-header {
		display: flex;
		flex-direction: column;
		gap: 8px;
		text-align: center;

		h3 {
			font-size: clamp(1.125em, 7cqi, 2.5em);
			margin: 0;
		}
	}

	.additional-details,
	.description,
	.supporters {
		h2 {
			font-size: 1.125rem;
			font-weight: 600;
			line-height: 1.1;
			margin-block: 0.25rem;
		}

		ul:not(.resources) {
			margin-block: 0.5rem 0;
			padding-inline-start: 20px;
		}

		li {
			margin-block-start: 0.25rem;
		}

		p {
			&:not(:first-child) {
				margin-block-start: 0.75rem;
			}
		}
	}

	.description {
		/* margin-block: 3rem; */
		max-inline-size: 54ch;

		@media (min-width: 1000px) {
			margin-block-start: 0;
		}

		h2 {
			margin-block: 1.5rem 0.5rem;
		}
	}

	.resources {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
		list-style: none;
		padding: 0;
	}

	.resource {
		display: block;
		max-inline-size: 90dvi;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
	}

	.transcript {
		margin-block-start: 30px;

		summary {
			font-weight: 600;
			margin-block-end: 15px;
		}
	}

	.sponsors {
		align-items: center;
		display: flex;
		flex-direction: column;
		gap: 8px;
		justify-content: center;
		margin: 0 0 40px;

		@media (min-width: 750px) {
			flex-direction: initial;
			gap: 40px;
		}

		h3 {
			color: var(--text-muted);
			font-size: 0.75rem;
			font-weight: 500;
			margin: 0;
			text-transform: uppercase;
			text-wrap: nowrap;
		}
	}

	.sponsor-logos {
		align-items: center;
		display: flex;
		flex-wrap: wrap;
		gap: 0 32px;
		justify-content: center;

		@media (min-width: 750px) {
			justify-content: start;
		}

		a {
			aspect-ratio: var(--ar);
			display: block;
		}

		img {
			aspect-ratio: var(--ar);
			block-size: 40px;
			display: block;
			inline-size: auto;
			margin: 0;
			object-fit: contain;
		}
	}

	.related-episodes {
		@media (min-width: 1000px) {
			grid-column: 1 / 3;
			margin-block-end: 3rem;
		}

		h2 {
			font-size: 1.125rem;
			font-weight: 600;
			margin-block-end: 0.75rem;
		}
	}
</style>
