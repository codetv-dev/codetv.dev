---
import { SignedIn, SignedOut } from "@clerk/astro/components";

export const prerender = false;

// TODO does this have any abuse vectors? I can't think of any, but...
const hasClerk = typeof Astro.locals.currentUser === 'function';
const user = hasClerk ? await Astro.locals.currentUser() : false;

const loggedOutText =
	Astro.cookies.get('has_codetv_account')?.value === 'true'
		? 'Log In'
		: 'Become a Supporter';
---

{!hasClerk ? (
	<a href="https://dashboard.clerk.com/last-active?path=api-keys" class="account">
		Add API Keys
		<img
			src="https://res.cloudinary.com/jlengstorf/image/upload/q_auto/f_auto/c_fill,w_60,ar_1/v1738215366/codetv/codetv-avatar.png"
			alt="loading"
		/>
	</a>
) : (

<SignedIn>
	{user ? (
		<a href="/dashboard" class="account" title="Manage your account">
			{user.firstName}
			<img src={user.imageUrl} alt={user.fullName} width={60} />
		</a>
	) : null}
</SignedIn>

<SignedOut>
	<a href="/dashboard/sign-in" class="button">
		{loggedOutText}
	</a>
</SignedOut>
)}

<style>
	.account {
		align-items: center;
		border: 1px solid color-mix(in oklch, var(--text-muted) 15%, transparent);
		border-radius: 5px;
		display: flex;
		font-family: var(--font-family);
		font-size: 0.75rem;
		gap: 10px;
		inline-size: max-content;
		margin-inline: auto;
		padding: 15px 5px 15px 10px;
		transition: background-color 100ms linear;

		@media (min-width: 1080px) {
			justify-content: space-between;
			min-inline-size: 150px;
			padding: 8px;
		}

		&:is(:hover, :focus) {
			background-color: color-mix(in oklch, var(--text-muted) 25%, transparent);
		}

		img {
			aspect-ratio: 1;
			block-size: auto;
			border-radius: 3px;
			display: block;
			inline-size: 30px;
			object-fit: cover;
			outline: 1px solid var(--text-muted);
		}
	}
</style>
