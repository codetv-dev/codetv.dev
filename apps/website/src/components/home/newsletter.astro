---
import { actions } from 'astro:actions';
---

<section class="newsletter">
	<h2>
		The best content <strong>made for developers</strong>, delivered directly to
		your inbox
	</h2>
	<p>
		Exclusive content, industry news, and more, all delivered directly to your
		inbox. No spam, no sharing your personal info, and you can opt out in a
		single click.
	</p>

	<form method="POST" action={actions.newsletter.subscribe}>
		<div class="input">
			<label for="firstName">First Name</label>
			<input type="text" name="firstName" id="firstName" required />
		</div>

		<div class="input">
			<label for="email">Email</label>
			<input type="email" name="email" id="email" required />
		</div>

		<button class="button" type="submit">Subscribe</button>
	</form>
</section>

<script>
	import { actions } from 'astro:actions';
	import { navigate } from 'astro:transitions/client';

	function setupSubmit() {
		const form = document.querySelector('form') as HTMLFormElement;

		async function handleSubmit(event: SubmitEvent) {
			event.preventDefault();

			const formData = new FormData(form);
			const input = {
				firstName: formData.get('firstName')?.toString() ?? '',
				email: formData.get('email')?.toString() ?? '',
			};

			const { error } = await actions.newsletter.subscribe(input);

			if (!error) {
				navigate('/confirm');
			}
		}

		// View Transitions + astro:page-load cause this code to re-execute
		// remove the listener first to avoid duplicate listeners
		form?.removeEventListener('submit', handleSubmit);
		form?.addEventListener('submit', handleSubmit);
	}

	document.addEventListener('astro:page-load', setupSubmit);
</script>

<style>
	.newsletter {
		background: var(--gray-000);
		box-shadow: 0 0 24px 8px color-mix(in oklch, var(--white) 10%, transparent);
		padding: 48px max((100% - 900px) / 2, 5%);
		position: relative;
		z-index: 100;
	}

	h2 {
		font-family: var(--font-family-heading);
		font-size: clamp(1.75rem, 4.5cqi, 3.5rem);
		font-weight: 900;
		font-variation-settings: 'wdth' 80;
		line-height: 0.9;
		margin: 0;
		text-transform: uppercase;

		strong {
			color: var(--orange);
			font-weight: inherit;
		}

		@media (min-width: 1280px) {
			font-size: clamp(2rem, 3cqi, 5rem);
		}
	}

	p {
		margin: 24px 0;
	}

	form {
		align-items: end;
		display: grid;
		gap: 8px;
		grid-template-columns: 1fr;

		@media (min-width: 880px) {
			grid-template-columns: 2fr 2fr 1fr;
		}
	}

	.input {
		display: flex;
		flex-direction: column;
		gap: 4px;

		label {
			color: var(--text-muted);
			font-size: 0.75em;
			transition: 150ms color linear;
		}

		input {
			background: var(--bg);
			border: 1px solid var(--text-muted);
			border-radius: 3px;
			color: var(--white);
			font-family: var(--font-family);
			font-size: 24px;
			inline-size: 100%;
			padding: 6px 8px;
			transition: 150ms border-color linear;
		}

		&:focus-within {
			label {
				color: var(--white);
			}

			input {
				border-color: var(--white);
			}
		}
	}

	.button {
		align-self: end;
		font-size: 20px;
		line-height: 1;
		margin: 0;
		padding: 10px 12px;
	}
</style>
